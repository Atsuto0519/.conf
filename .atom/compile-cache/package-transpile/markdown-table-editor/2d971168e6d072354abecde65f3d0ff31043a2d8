"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _atom = require("atom");

var _mteKernel = require("@susisu/mte-kernel");

var _editorController = require("./editor-controller.js");

var _editorController2 = _interopRequireDefault(_editorController);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const COMMAND_TARGET = "atom-text-editor:not(.mini):not(.autocomplete-active)";
const EDITOR_COMMAND_TARGET = COMMAND_TARGET + ".markdown-table-editor-active";
const NAMESPACE = "markdown-table-editor";

const FORMAT_TYPES = [_mteKernel.FormatType.NORMAL, _mteKernel.FormatType.WEAK];
const FORMAT_TYPE_NAMES = {
  [_mteKernel.FormatType.NORMAL]: "Normal",
  [_mteKernel.FormatType.WEAK]: "Weak"
};

class Controller {
  constructor() {
    this.editorCtrlers = new Map();

    // event subscriptions
    this.subscriptions = new _atom.CompositeDisposable();

    // editor
    this.subscriptions.add(atom.workspace.observeTextEditors(editor => {
      this.addEditor(editor);
    }));
    this.subscriptions.add(atom.workspace.onDidDestroyPaneItem(item => {
      this.removeEditor(item);
    }));

    // commands
    this.subscriptions.add(atom.commands.add(COMMAND_TARGET, {
      [`${NAMESPACE}:toggle-format-on-save`]: () => {
        this.toggleFormatOnSave();
      },
      [`${NAMESPACE}:switch-format-type`]: () => {
        this.switchFormatType();
      },
      [`${NAMESPACE}:set-format-type-normal`]: () => {
        this.setFormatType(_mteKernel.FormatType.NORMAL);
      },
      [`${NAMESPACE}:set-format-type-weak`]: () => {
        this.setFormatType(_mteKernel.FormatType.WEAK);
      },
      [`${NAMESPACE}:format-all`]: this.editorCommand(editorCtrler => {
        editorCtrler.formatAll();
      })
    }));
    this.subscriptions.add(atom.commands.add(EDITOR_COMMAND_TARGET, {
      [`${NAMESPACE}:format`]: this.editorCommand(editorCtrler => {
        editorCtrler.format();
      }),
      [`${NAMESPACE}:escape`]: this.editorCommand(editorCtrler => {
        editorCtrler.escape();
      }),
      [`${NAMESPACE}:align-left`]: this.editorCommand(editorCtrler => {
        editorCtrler.alignLeft();
      }),
      [`${NAMESPACE}:align-right`]: this.editorCommand(editorCtrler => {
        editorCtrler.alignRight();
      }),
      [`${NAMESPACE}:align-center`]: this.editorCommand(editorCtrler => {
        editorCtrler.alignCenter();
      }),
      [`${NAMESPACE}:align-none`]: this.editorCommand(editorCtrler => {
        editorCtrler.alignNone();
      }),
      [`${NAMESPACE}:align-default`]: this.editorCommand(editorCtrler => {
        editorCtrler.alignNone();
      }),
      [`${NAMESPACE}:select-cell`]: this.editorCommand(editorCtrler => {
        editorCtrler.selectCell();
      }),
      [`${NAMESPACE}:move-left`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveLeft();
      }),
      [`${NAMESPACE}:move-right`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveRight();
      }),
      [`${NAMESPACE}:move-up`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveUp();
      }),
      [`${NAMESPACE}:move-down`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveDown();
      }),
      [`${NAMESPACE}:next-cell`]: this.editorCommand(editorCtrler => {
        editorCtrler.nextCell();
      }),
      [`${NAMESPACE}:previous-cell`]: this.editorCommand(editorCtrler => {
        editorCtrler.previousCell();
      }),
      [`${NAMESPACE}:next-row`]: this.editorCommand(editorCtrler => {
        editorCtrler.nextRow();
      }),
      [`${NAMESPACE}:insert-row`]: this.editorCommand(editorCtrler => {
        editorCtrler.insertRow();
      }),
      [`${NAMESPACE}:delete-row`]: this.editorCommand(editorCtrler => {
        editorCtrler.deleteRow();
      }),
      [`${NAMESPACE}:move-row-up`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveRowUp();
      }),
      [`${NAMESPACE}:move-row-down`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveRowDown();
      }),
      [`${NAMESPACE}:insert-column`]: this.editorCommand(editorCtrler => {
        editorCtrler.insertColumn();
      }),
      [`${NAMESPACE}:delete-column`]: this.editorCommand(editorCtrler => {
        editorCtrler.deleteColumn();
      }),
      [`${NAMESPACE}:move-column-left`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveColumnLeft();
      }),
      [`${NAMESPACE}:move-column-right`]: this.editorCommand(editorCtrler => {
        editorCtrler.moveColumnRight();
      })
    }));
  }

  addEditor(editor) {
    const editorCtrler = new _editorController2.default(editor);
    this.editorCtrlers.set(editor.element, editorCtrler);
  }

  removeEditor(editor) {
    this.editorCtrlers.delete(editor.element);
  }

  toggleFormatOnSave() {
    const formatOnSave = atom.config.get(`${NAMESPACE}.formatOnSave`);
    atom.config.set(`${NAMESPACE}.formatOnSave`, !formatOnSave);
    atom.notifications.addInfo("markdown-table-editor", {
      detail: `"Format On Save" is turned ${!formatOnSave ? "on" : "off"}`
    });
  }

  switchFormatType() {
    const formatType = atom.config.get(`${NAMESPACE}.formatType`);
    const i = FORMAT_TYPES.indexOf(formatType);
    const newFormatType = FORMAT_TYPES[i + 1 > FORMAT_TYPES.length - 1 ? 0 : i + 1];
    atom.config.set(`${NAMESPACE}.formatType`, newFormatType);
    atom.notifications.addInfo("markdown-table-editor", {
      detail: `"Format Type" is switched to "${FORMAT_TYPE_NAMES[newFormatType]}"`
    });
  }

  setFormatType(type) {
    atom.config.set(`${NAMESPACE}.formatType`, type);
    atom.notifications.addInfo("markdown-table-editor", {
      detail: `"Format Type" is set to "${FORMAT_TYPE_NAMES[type]}"`
    });
  }

  editorCommand(callback) {
    return event => {
      if (this.editorCtrlers.has(event.currentTarget)) {
        callback(this.editorCtrlers.get(event.currentTarget));
      }
    };
  }

  destroy() {
    this.subscriptions.dispose();

    for (const editorCtrler of this.editorCtrlers.values()) {
      editorCtrler.destroy();
    }
  }
}
exports.default = Controller;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiQ09NTUFORF9UQVJHRVQiLCJFRElUT1JfQ09NTUFORF9UQVJHRVQiLCJOQU1FU1BBQ0UiLCJGT1JNQVRfVFlQRVMiLCJGb3JtYXRUeXBlIiwiTk9STUFMIiwiV0VBSyIsIkZPUk1BVF9UWVBFX05BTUVTIiwiQ29udHJvbGxlciIsImNvbnN0cnVjdG9yIiwiZWRpdG9yQ3RybGVycyIsIk1hcCIsInN1YnNjcmlwdGlvbnMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwiYWRkIiwiYXRvbSIsIndvcmtzcGFjZSIsIm9ic2VydmVUZXh0RWRpdG9ycyIsImVkaXRvciIsImFkZEVkaXRvciIsIm9uRGlkRGVzdHJveVBhbmVJdGVtIiwiaXRlbSIsInJlbW92ZUVkaXRvciIsImNvbW1hbmRzIiwidG9nZ2xlRm9ybWF0T25TYXZlIiwic3dpdGNoRm9ybWF0VHlwZSIsInNldEZvcm1hdFR5cGUiLCJlZGl0b3JDb21tYW5kIiwiZWRpdG9yQ3RybGVyIiwiZm9ybWF0QWxsIiwiZm9ybWF0IiwiZXNjYXBlIiwiYWxpZ25MZWZ0IiwiYWxpZ25SaWdodCIsImFsaWduQ2VudGVyIiwiYWxpZ25Ob25lIiwic2VsZWN0Q2VsbCIsIm1vdmVMZWZ0IiwibW92ZVJpZ2h0IiwibW92ZVVwIiwibW92ZURvd24iLCJuZXh0Q2VsbCIsInByZXZpb3VzQ2VsbCIsIm5leHRSb3ciLCJpbnNlcnRSb3ciLCJkZWxldGVSb3ciLCJtb3ZlUm93VXAiLCJtb3ZlUm93RG93biIsImluc2VydENvbHVtbiIsImRlbGV0ZUNvbHVtbiIsIm1vdmVDb2x1bW5MZWZ0IiwibW92ZUNvbHVtblJpZ2h0IiwiRWRpdG9yQ29udHJvbGxlciIsInNldCIsImVsZW1lbnQiLCJkZWxldGUiLCJmb3JtYXRPblNhdmUiLCJjb25maWciLCJnZXQiLCJub3RpZmljYXRpb25zIiwiYWRkSW5mbyIsImRldGFpbCIsImZvcm1hdFR5cGUiLCJpIiwiaW5kZXhPZiIsIm5ld0Zvcm1hdFR5cGUiLCJsZW5ndGgiLCJ0eXBlIiwiY2FsbGJhY2siLCJldmVudCIsImhhcyIsImN1cnJlbnRUYXJnZXQiLCJkZXN0cm95IiwiZGlzcG9zZSIsInZhbHVlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7Ozs7OztBQUVBLE1BQU1BLGlCQUFpQix1REFBdkI7QUFDQSxNQUFNQyx3QkFBd0JELGlCQUFpQiwrQkFBL0M7QUFDQSxNQUFNRSxZQUFZLHVCQUFsQjs7QUFFQSxNQUFNQyxlQUFlLENBQUNDLHNCQUFXQyxNQUFaLEVBQW9CRCxzQkFBV0UsSUFBL0IsQ0FBckI7QUFDQSxNQUFNQyxvQkFBb0I7QUFDeEIsR0FBQ0gsc0JBQVdDLE1BQVosR0FBcUIsUUFERztBQUV4QixHQUFDRCxzQkFBV0UsSUFBWixHQUFxQjtBQUZHLENBQTFCOztBQUtlLE1BQU1FLFVBQU4sQ0FBaUI7QUFDOUJDLGdCQUFjO0FBQ1osU0FBS0MsYUFBTCxHQUFxQixJQUFJQyxHQUFKLEVBQXJCOztBQUVBO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQixJQUFJQyx5QkFBSixFQUFyQjs7QUFFQTtBQUNBLFNBQUtELGFBQUwsQ0FBbUJFLEdBQW5CLENBQXVCQyxLQUFLQyxTQUFMLENBQWVDLGtCQUFmLENBQWtDQyxVQUFVO0FBQ2pFLFdBQUtDLFNBQUwsQ0FBZUQsTUFBZjtBQUNELEtBRnNCLENBQXZCO0FBR0EsU0FBS04sYUFBTCxDQUFtQkUsR0FBbkIsQ0FBdUJDLEtBQUtDLFNBQUwsQ0FBZUksb0JBQWYsQ0FBb0NDLFFBQVE7QUFDakUsV0FBS0MsWUFBTCxDQUFrQkQsSUFBbEI7QUFDRCxLQUZzQixDQUF2Qjs7QUFJQTtBQUNBLFNBQUtULGFBQUwsQ0FBbUJFLEdBQW5CLENBQXVCQyxLQUFLUSxRQUFMLENBQWNULEdBQWQsQ0FBa0JkLGNBQWxCLEVBQWtDO0FBQ3ZELE9BQUUsR0FBRUUsU0FBVSx3QkFBZCxHQUF3QyxNQUFNO0FBQzVDLGFBQUtzQixrQkFBTDtBQUNELE9BSHNEO0FBSXZELE9BQUUsR0FBRXRCLFNB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O0FBRHhCLEtBQXBEO0FBR0Q7O0FBRUR2QyxnQkFBY3lDLElBQWQsRUFBb0I7QUFDbEJwRCxTQUFLMEMsTUFBTCxDQUFZSixHQUFaLENBQWlCLEdBQUVuRCxTQUFVLGFBQTdCLEVBQTJDaUUsSUFBM0M7QUFDQXBELFNBQUs0QyxhQUFMLENBQW1CQyxPQUFuQixDQUEyQix1QkFBM0IsRUFBb0Q7QUFDbERDLGNBQVMsNEJBQTJCdEQsa0JBQWtCNEQsSUFBbEIsQ0FBd0I7QUFEVixLQUFwRDtBQUdEOztBQUVEeEMsZ0JBQWN5QyxRQUFkLEVBQXdCO0FBQ3RCLFdBQU9DLFNBQVM7QUFDZCxVQUFJLEtBQUszRCxhQUFMLENBQW1CNEQsR0FBbkIsQ0FBdUJELE1BQU1FLGFBQTdCLENBQUosRUFBaUQ7QUFDL0NILGlCQUFTLEtBQUsxRCxhQUFMLENBQW1CZ0QsR0FBbkIsQ0FBdUJXLE1BQU1FLGFBQTdCLENBQVQ7QUFDRDtBQUNGLEtBSkQ7QUFLRDs7QUFFREMsWUFBVTtBQUNSLFNBQUs1RCxhQUFMLENBQW1CNkQsT0FBbkI7O0FBRUEsU0FBSyxNQUFNN0MsWUFBWCxJQUEyQixLQUFLbEIsYUFBTCxDQUFtQmdFLE1BQW5CLEVBQTNCLEVBQXdEO0FBQ3REOUMsbUJBQWE0QyxPQUFiO0FBQ0Q7QUFDRjtBQTFKNkI7a0JBQVhoRSxVIiwiZmlsZSI6ImNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2hvdG1hbi8uYXRvbS9wYWNrYWdlcy9tYXJrZG93bi10YWJsZS1lZGl0b3IvbGliIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gXCJhdG9tXCI7XG5pbXBvcnQgeyBGb3JtYXRUeXBlIH0gZnJvbSBcIkBzdXNpc3UvbXRlLWtlcm5lbFwiO1xuXG5pbXBvcnQgRWRpdG9yQ29udHJvbGxlciBmcm9tIFwiLi9lZGl0b3ItY29udHJvbGxlci5qc1wiO1xuXG5jb25zdCBDT01NQU5EX1RBUkdFVCA9IFwiYXRvbS10ZXh0LWVkaXRvcjpub3QoLm1pbmkpOm5vdCguYXV0b2NvbXBsZXRlLWFjdGl2ZSlcIjtcbmNvbnN0IEVESVRPUl9DT01NQU5EX1RBUkdFVCA9IENPTU1BTkRfVEFSR0VUICsgXCIubWFya2Rvd24tdGFibGUtZWRpdG9yLWFjdGl2ZVwiO1xuY29uc3QgTkFNRVNQQUNFID0gXCJtYXJrZG93bi10YWJsZS1lZGl0b3JcIjtcblxuY29uc3QgRk9STUFUX1RZUEVTID0gW0Zvcm1hdFR5cGUuTk9STUFMLCBGb3JtYXRUeXBlLldFQUtdO1xuY29uc3QgRk9STUFUX1RZUEVfTkFNRVMgPSB7XG4gIFtGb3JtYXRUeXBlLk5PUk1BTF06IFwiTm9ybWFsXCIsXG4gIFtGb3JtYXRUeXBlLldFQUtdICA6IFwiV2Vha1wiXG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5lZGl0b3JDdHJsZXJzID0gbmV3IE1hcCgpO1xuXG4gICAgLy8gZXZlbnQgc3Vic2NyaXB0aW9uc1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbiAgICAvLyBlZGl0b3JcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycyhlZGl0b3IgPT4ge1xuICAgICAgdGhpcy5hZGRFZGl0b3IoZWRpdG9yKTtcbiAgICB9KSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChhdG9tLndvcmtzcGFjZS5vbkRpZERlc3Ryb3lQYW5lSXRlbShpdGVtID0+IHtcbiAgICAgIHRoaXMucmVtb3ZlRWRpdG9yKGl0ZW0pO1xuICAgIH0pKTtcblxuICAgIC8vIGNvbW1hbmRzXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChhdG9tLmNvbW1hbmRzLmFkZChDT01NQU5EX1RBUkdFVCwge1xuICAgICAgW2Ake05BTUVTUEFDRX06dG9nZ2xlLWZvcm1hdC1vbi1zYXZlYF06ICgpID0+IHtcbiAgICAgICAgdGhpcy50b2dnbGVGb3JtYXRPblNhdmUoKTtcbiAgICAgIH0sXG4gICAgICBbYCR7TkFNRVNQQUNFfTpzd2l0Y2gtZm9ybWF0LXR5cGVgXTogKCkgPT4ge1xuICAgICAgICB0aGlzLnN3aXRjaEZvcm1hdFR5cGUoKTtcbiAgICAgIH0sXG4gICAgICBbYCR7TkFNRVNQQUNFfTpzZXQtZm9ybWF0LXR5cGUtbm9ybWFsYF06ICgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRGb3JtYXRUeXBlKEZvcm1hdFR5cGUuTk9STUFMKTtcbiAgICAgIH0sXG4gICAgICBbYCR7TkFNRVNQQUNFfTpzZXQtZm9ybWF0LXR5cGUtd2Vha2BdOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0Rm9ybWF0VHlwZShGb3JtYXRUeXBlLldFQUspO1xuICAgICAgfSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9OmZvcm1hdC1hbGxgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5mb3JtYXRBbGwoKTtcbiAgICAgIH0pXG4gICAgfSkpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoYXRvbS5jb21tYW5kcy5hZGQoRURJVE9SX0NPTU1BTkRfVEFSR0VULCB7XG4gICAgICBbYCR7TkFNRVNQQUNFfTpmb3JtYXRgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5mb3JtYXQoKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06ZXNjYXBlYF06IHRoaXMuZWRpdG9yQ29tbWFuZChlZGl0b3JDdHJsZXIgPT4ge1xuICAgICAgICBlZGl0b3JDdHJsZXIuZXNjYXBlKCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9OmFsaWduLWxlZnRgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5hbGlnbkxlZnQoKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06YWxpZ24tcmlnaHRgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5hbGlnblJpZ2h0KCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9OmFsaWduLWNlbnRlcmBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLmFsaWduQ2VudGVyKCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9OmFsaWduLW5vbmVgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5hbGlnbk5vbmUoKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06YWxpZ24tZGVmYXVsdGBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLmFsaWduTm9uZSgpO1xuICAgICAgfSksXG4gICAgICBbYCR7TkFNRVNQQUNFfTpzZWxlY3QtY2VsbGBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLnNlbGVjdENlbGwoKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06bW92ZS1sZWZ0YF06IHRoaXMuZWRpdG9yQ29tbWFuZChlZGl0b3JDdHJsZXIgPT4ge1xuICAgICAgICBlZGl0b3JDdHJsZXIubW92ZUxlZnQoKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06bW92ZS1yaWdodGBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLm1vdmVSaWdodCgpO1xuICAgICAgfSksXG4gICAgICBbYCR7TkFNRVNQQUNFfTptb3ZlLXVwYF06IHRoaXMuZWRpdG9yQ29tbWFuZChlZGl0b3JDdHJsZXIgPT4ge1xuICAgICAgICBlZGl0b3JDdHJsZXIubW92ZVVwKCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9Om1vdmUtZG93bmBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLm1vdmVEb3duKCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9Om5leHQtY2VsbGBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLm5leHRDZWxsKCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9OnByZXZpb3VzLWNlbGxgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5wcmV2aW91c0NlbGwoKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06bmV4dC1yb3dgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5uZXh0Um93KCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9Omluc2VydC1yb3dgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5pbnNlcnRSb3coKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06ZGVsZXRlLXJvd2BdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLmRlbGV0ZVJvdygpO1xuICAgICAgfSksXG4gICAgICBbYCR7TkFNRVNQQUNFfTptb3ZlLXJvdy11cGBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLm1vdmVSb3dVcCgpO1xuICAgICAgfSksXG4gICAgICBbYCR7TkFNRVNQQUNFfTptb3ZlLXJvdy1kb3duYF06IHRoaXMuZWRpdG9yQ29tbWFuZChlZGl0b3JDdHJsZXIgPT4ge1xuICAgICAgICBlZGl0b3JDdHJsZXIubW92ZVJvd0Rvd24oKTtcbiAgICAgIH0pLFxuICAgICAgW2Ake05BTUVTUEFDRX06aW5zZXJ0LWNvbHVtbmBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLmluc2VydENvbHVtbigpO1xuICAgICAgfSksXG4gICAgICBbYCR7TkFNRVNQQUNFfTpkZWxldGUtY29sdW1uYF06IHRoaXMuZWRpdG9yQ29tbWFuZChlZGl0b3JDdHJsZXIgPT4ge1xuICAgICAgICBlZGl0b3JDdHJsZXIuZGVsZXRlQ29sdW1uKCk7XG4gICAgICB9KSxcbiAgICAgIFtgJHtOQU1FU1BBQ0V9Om1vdmUtY29sdW1uLWxlZnRgXTogdGhpcy5lZGl0b3JDb21tYW5kKGVkaXRvckN0cmxlciA9PiB7XG4gICAgICAgIGVkaXRvckN0cmxlci5tb3ZlQ29sdW1uTGVmdCgpO1xuICAgICAgfSksXG4gICAgICBbYCR7TkFNRVNQQUNFfTptb3ZlLWNvbHVtbi1yaWdodGBdOiB0aGlzLmVkaXRvckNvbW1hbmQoZWRpdG9yQ3RybGVyID0+IHtcbiAgICAgICAgZWRpdG9yQ3RybGVyLm1vdmVDb2x1bW5SaWdodCgpO1xuICAgICAgfSlcbiAgICB9KSk7XG4gIH1cblxuICBhZGRFZGl0b3IoZWRpdG9yKSB7XG4gICAgY29uc3QgZWRpdG9yQ3RybGVyID0gbmV3IEVkaXRvckNvbnRyb2xsZXIoZWRpdG9yKTtcbiAgICB0aGlzLmVkaXRvckN0cmxlcnMuc2V0KGVkaXRvci5lbGVtZW50LCBlZGl0b3JDdHJsZXIpO1xuICB9XG5cbiAgcmVtb3ZlRWRpdG9yKGVkaXRvcikge1xuICAgIHRoaXMuZWRpdG9yQ3RybGVycy5kZWxldGUoZWRpdG9yLmVsZW1lbnQpO1xuICB9XG5cbiAgdG9nZ2xlRm9ybWF0T25TYXZlKCkge1xuICAgIGNvbnN0IGZvcm1hdE9uU2F2ZSA9IGF0b20uY29uZmlnLmdldChgJHtOQU1FU1BBQ0V9LmZvcm1hdE9uU2F2ZWApO1xuICAgIGF0b20uY29uZmlnLnNldChgJHtOQU1FU1BBQ0V9LmZvcm1hdE9uU2F2ZWAsICFmb3JtYXRPblNhdmUpO1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKFwibWFya2Rvd24tdGFibGUtZWRpdG9yXCIsIHtcbiAgICAgIGRldGFpbDogYFwiRm9ybWF0IE9uIFNhdmVcIiBpcyB0dXJuZWQgJHshZm9ybWF0T25TYXZlID8gXCJvblwiIDogXCJvZmZcIn1gXG4gICAgfSk7XG4gIH1cblxuICBzd2l0Y2hGb3JtYXRUeXBlKCkge1xuICAgIGNvbnN0IGZvcm1hdFR5cGUgPSBhdG9tLmNvbmZpZy5nZXQoYCR7TkFNRVNQQUNFfS5mb3JtYXRUeXBlYCk7XG4gICAgY29uc3QgaSA9IEZPUk1BVF9UWVBFUy5pbmRleE9mKGZvcm1hdFR5cGUpO1xuICAgIGNvbnN0IG5ld0Zvcm1hdFR5cGUgPSBGT1JNQVRfVFlQRVNbaSArIDEgPiBGT1JNQVRfVFlQRVMubGVuZ3RoIC0gMSA/IDAgOiBpICsgMV07XG4gICAgYXRvbS5jb25maWcuc2V0KGAke05BTUVTUEFDRX0uZm9ybWF0VHlwZWAsIG5ld0Zvcm1hdFR5cGUpO1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKFwibWFya2Rvd24tdGFibGUtZWRpdG9yXCIsIHtcbiAgICAgIGRldGFpbDogYFwiRm9ybWF0IFR5cGVcIiBpcyBzd2l0Y2hlZCB0byBcIiR7Rk9STUFUX1RZUEVfTkFNRVNbbmV3Rm9ybWF0VHlwZV19XCJgXG4gICAgfSk7XG4gIH1cblxuICBzZXRGb3JtYXRUeXBlKHR5cGUpIHtcbiAgICBhdG9tLmNvbmZpZy5zZXQoYCR7TkFNRVNQQUNFfS5mb3JtYXRUeXBlYCwgdHlwZSk7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oXCJtYXJrZG93bi10YWJsZS1lZGl0b3JcIiwge1xuICAgICAgZGV0YWlsOiBgXCJGb3JtYXQgVHlwZVwiIGlzIHNldCB0byBcIiR7Rk9STUFUX1RZUEVfTkFNRVNbdHlwZV19XCJgXG4gICAgfSk7XG4gIH1cblxuICBlZGl0b3JDb21tYW5kKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIGV2ZW50ID0+IHtcbiAgICAgIGlmICh0aGlzLmVkaXRvckN0cmxlcnMuaGFzKGV2ZW50LmN1cnJlbnRUYXJnZXQpKSB7XG4gICAgICAgIGNhbGxiYWNrKHRoaXMuZWRpdG9yQ3RybGVycy5nZXQoZXZlbnQuY3VycmVudFRhcmdldCkpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kaXNwb3NlKCk7XG5cbiAgICBmb3IgKGNvbnN0IGVkaXRvckN0cmxlciBvZiB0aGlzLmVkaXRvckN0cmxlcnMudmFsdWVzKCkpIHtcbiAgICAgIGVkaXRvckN0cmxlci5kZXN0cm95KCk7XG4gICAgfVxuICB9XG59XG4iXX0=