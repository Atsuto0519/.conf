"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _atom = require("atom");

var _mteKernel = require("@susisu/mte-kernel");

var _textEditorInterface = require("./text-editor-interface.js");

var _textEditorInterface2 = _interopRequireDefault(_textEditorInterface);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const NAMESPACE = "markdown-table-editor";
const ACTIVE_CLASS = "markdown-table-editor-active";

class EditorController {
  constructor(editor) {
    this.editor = editor;
    this.editorIntf = new _textEditorInterface2.default(this.editor, atom.config.get(`${NAMESPACE}.scopes`));
    this.tableEditor = new _mteKernel.TableEditor(this.editorIntf);

    this.updateActiveState();

    // event subscriptions
    this.subscriptions = new _atom.CompositeDisposable();

    // editor
    this.subscriptions.add(this.editor.onDidChangeGrammar(() => {
      this.updateActiveState();
    }));
    this.subscriptions.add(this.editor.onDidAddCursor(() => {
      this.updateActiveState();
    }));
    this.subscriptions.add(this.editor.onDidRemoveCursor(() => {
      this.updateActiveState();
    }));
    this.subscriptions.add(this.editor.onDidChangeCursorPosition(event => {
      if (!this.editorIntf.transaction && event.newBufferPosition.row !== event.oldBufferPosition.row) {
        this.updateActiveState();
      }
    }));
    this.subscriptions.add(this.editor.onDidStopChanging(() => {
      if (!this.editorIntf.transaction) {
        this.updateActiveState();
      }
    }));
    this.subscriptions.add(this.editorIntf.onDidFinishTransaction(() => {
      this.updateActiveState();
    }));
    this.subscriptions.add(this.editor.getBuffer().onWillSave(() => {
      if (atom.config.get(`${NAMESPACE}.formatOnSave`)) {
        this.formatAll();
      }
    }));

    // config
    this.subscriptions.add(atom.config.observe(`${NAMESPACE}.scopes`, scopes => {
      this.editorIntf.scopes = scopes;
      this.updateActiveState();
    }));
  }

  updateActiveState() {
    const isActive = !this.editor.hasMultipleCursors() && this.tableEditor.cursorIsInTable(this.getOptions());
    if (isActive) {
      this.editor.element.classList.add(ACTIVE_CLASS);
    } else {
      this.editor.element.classList.remove(ACTIVE_CLASS);
      this.tableEditor.resetSmartCursor();
    }
  }

  getOptions() {
    const configOpt = {
      scope: this.editor.scopeDescriptorForBufferPosition(this.editor.getCursorBufferPosition())
    };
    return (0, _mteKernel.options)({
      leftMarginChars: new Set(atom.config.get(`${NAMESPACE}.leftMarginChars`, configOpt)),
      formatType: atom.config.get(`${NAMESPACE}.formatType`, configOpt),
      minDelimiterWidth: atom.config.get(`${NAMESPACE}.minDelimiterWidth`, configOpt),
      defaultAlignment: atom.config.get(`${NAMESPACE}.defaultAlignment`, configOpt),
      headerAlignment: atom.config.get(`${NAMESPACE}.headerAlignment`, configOpt),
      smartCursor: atom.config.get(`${NAMESPACE}.smartCursor`, configOpt),
      textWidthOptions: {
        normalize: atom.config.get(`${NAMESPACE}.normalize`, configOpt),
        wideChars: new Set(atom.config.get(`${NAMESPACE}.wideChars`, configOpt)),
        narrowChars: new Set(atom.config.get(`${NAMESPACE}.narrowChars`, configOpt)),
        ambiguousAsWide: atom.config.get(`${NAMESPACE}.ambiguousAsWide`, configOpt)
      }
    });
  }

  format() {
    this.tableEditor.format(this.getOptions());
  }

  formatAll() {
    this.tableEditor.formatAll(this.getOptions());
  }

  escape() {
    this.tableEditor.escape(this.getOptions());
  }

  alignLeft() {
    this.tableEditor.alignColumn(_mteKernel.Alignment.LEFT, this.getOptions());
  }

  alignRight() {
    this.tableEditor.alignColumn(_mteKernel.Alignment.RIGHT, this.getOptions());
  }

  alignCenter() {
    this.tableEditor.alignColumn(_mteKernel.Alignment.CENTER, this.getOptions());
  }

  alignNone() {
    this.tableEditor.alignColumn(_mteKernel.Alignment.NONE, this.getOptions());
  }

  selectCell() {
    this.tableEditor.selectCell(this.getOptions());
  }

  moveLeft() {
    this.tableEditor.moveFocus(0, -1, this.getOptions());
  }

  moveRight() {
    this.tableEditor.moveFocus(0, 1, this.getOptions());
  }

  moveUp() {
    this.tableEditor.moveFocus(-1, 0, this.getOptions());
  }

  moveDown() {
    this.tableEditor.moveFocus(1, 0, this.getOptions());
  }

  nextCell() {
    this.tableEditor.nextCell(this.getOptions());
  }

  previousCell() {
    this.tableEditor.previousCell(this.getOptions());
  }

  nextRow() {
    this.tableEditor.nextRow(this.getOptions());
  }

  insertRow() {
    this.tableEditor.insertRow(this.getOptions());
  }

  deleteRow() {
    this.tableEditor.deleteRow(this.getOptions());
  }

  moveRowUp() {
    this.tableEditor.moveRow(-1, this.getOptions());
  }

  moveRowDown() {
    this.tableEditor.moveRow(1, this.getOptions());
  }

  insertColumn() {
    this.tableEditor.insertColumn(this.getOptions());
  }

  deleteColumn() {
    this.tableEditor.deleteColumn(this.getOptions());
  }

  moveColumnLeft() {
    this.tableEditor.moveColumn(-1, this.getOptions());
  }

  moveColumnRight() {
    this.tableEditor.moveColumn(1, this.getOptions());
  }

  destroy() {
    this.subscriptions.dispose();
    this.editorIntf.destroy();
  }
}
exports.default = EditorController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVkaXRvci1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIk5BTUVTUEFDRSIsIkFDVElWRV9DTEFTUyIsIkVkaXRvckNvbnRyb2xsZXIiLCJjb25zdHJ1Y3RvciIsImVkaXRvciIsImVkaXRvckludGYiLCJUZXh0RWRpdG9ySW50ZXJmYWNlIiwiYXRvbSIsImNvbmZpZyIsImdldCIsInRhYmxlRWRpdG9yIiwiVGFibGVFZGl0b3IiLCJ1cGRhdGVBY3RpdmVTdGF0ZSIsInN1YnNjcmlwdGlvbnMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwiYWRkIiwib25EaWRDaGFuZ2VHcmFtbWFyIiwib25EaWRBZGRDdXJzb3IiLCJvbkRpZFJlbW92ZUN1cnNvciIsIm9uRGlkQ2hhbmdlQ3Vyc29yUG9zaXRpb24iLCJldmVudCIsInRyYW5zYWN0aW9uIiwibmV3QnVmZmVyUG9zaXRpb24iLCJyb3ciLCJvbGRCdWZmZXJQb3NpdGlvbiIsIm9uRGlkU3RvcENoYW5naW5nIiwib25EaWRGaW5pc2hUcmFuc2FjdGlvbiIsImdldEJ1ZmZlciIsIm9uV2lsbFNhdmUiLCJmb3JtYXRBbGwiLCJvYnNlcnZlIiwic2NvcGVzIiwiaXNBY3RpdmUiLCJoYXNNdWx0aXBsZUN1cnNvcnMiLCJjdXJzb3JJc0luVGFibGUiLCJnZXRPcHRpb25zIiwiZWxlbWVudCIsImNsYXNzTGlzdCIsInJlbW92ZSIsInJlc2V0U21hcnRDdXJzb3IiLCJjb25maWdPcHQiLCJzY29wZSIsInNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uIiwiZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24iLCJsZWZ0TWFyZ2luQ2hhcnMiLCJTZXQiLCJmb3JtYXRUeXBlIiwibWluRGVsaW1pdGVyV2lkdGgiLCJkZWZhdWx0QWxpZ25tZW50IiwiaGVhZGVyQWxpZ25tZW50Iiwic21hcnRDdXJzb3IiLCJ0ZXh0V2lkdGhPcHRpb25zIiwibm9ybWFsaXplIiwid2lkZUNoYXJzIiwibmFycm93Q2hhcnMiLCJhbWJpZ3VvdXNBc1dpZGUiLCJmb3JtYXQiLCJlc2NhcGUiLCJhbGlnbkxlZnQiLCJhbGlnbkNvbHVtbiIsIkFsaWdubWVudCIsIkxFRlQiLCJhbGlnblJpZ2h0IiwiUklHSFQiLCJhbGlnbkNlbnRlciIsIkNFTlRFUiIsImFsaWduTm9uZSIsIk5PTkUiLCJzZWxlY3RDZWxsIiwibW92ZUxlZnQiLCJtb3ZlRm9jdXMiLCJtb3ZlUmlnaHQiLCJtb3ZlVXAiLCJtb3ZlRG93biIsIm5leHRDZWxsIiwicHJldmlvdXNDZWxsIiwibmV4dFJvdyIsImluc2VydFJvdyIsImRlbGV0ZVJvdyIsIm1vdmVSb3dVcCIsIm1vdmVSb3ciLCJtb3ZlUm93RG93biIsImluc2VydENvbHVtbiIsImRlbGV0ZUNvbHVtbiIsIm1vdmVDb2x1bW5MZWZ0IiwibW92ZUNvbHVtbiIsIm1vdmVDb2x1bW5SaWdodCIsImRlc3Ryb3kiLCJkaXNwb3NlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7Ozs7O0FBRUEsTUFBTUEsWUFBWSx1QkFBbEI7QUFDQSxNQUFNQyxlQUFlLDhCQUFyQjs7QUFFZSxNQUFNQyxnQkFBTixDQUF1QjtBQUNwQ0MsY0FBWUMsTUFBWixFQUFvQjtBQUNsQixTQUFLQSxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxVQUFMLEdBQWtCLElBQUlDLDZCQUFKLENBQXdCLEtBQUtGLE1BQTdCLEVBQXFDRyxLQUFLQyxNQUFMLENBQVlDLEdBQVosQ0FBaUIsR0FBRVQsU0FBVSxTQUE3QixDQUFyQyxDQUFsQjtBQUNBLFNBQUtVLFdBQUwsR0FBbUIsSUFBSUMsc0JBQUosQ0FBZ0IsS0FBS04sVUFBckIsQ0FBbkI7O0FBRUEsU0FBS08saUJBQUw7O0FBRUE7QUFDQSxTQUFLQyxhQUFMLEdBQXFCLElBQUlDLHlCQUFKLEVBQXJCOztBQUVBO0FBQ0EsU0FBS0QsYUFBTCxDQUFtQkUsR0FBbkIsQ0FBdUIsS0FBS1gsTUFBTCxDQUFZWSxrQkFBWixDQUErQixNQUFNO0FBQzFELFdBQUtKLGlCQUFMO0FBQ0QsS0FGc0Is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Iiwic291cmNlUm9vdCI6Ii9Vc2Vycy9ob3RtYW4vLmF0b20vcGFja2FnZXMvbWFya2Rvd24tdGFibGUtZWRpdG9yL2xpYiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tIFwiYXRvbVwiO1xuaW1wb3J0IHsgVGFibGVFZGl0b3IsIG9wdGlvbnMsIEFsaWdubWVudCB9IGZyb20gXCJAc3VzaXN1L210ZS1rZXJuZWxcIjtcblxuaW1wb3J0IFRleHRFZGl0b3JJbnRlcmZhY2UgZnJvbSBcIi4vdGV4dC1lZGl0b3ItaW50ZXJmYWNlLmpzXCI7XG5cbmNvbnN0IE5BTUVTUEFDRSA9IFwibWFya2Rvd24tdGFibGUtZWRpdG9yXCI7XG5jb25zdCBBQ1RJVkVfQ0xBU1MgPSBcIm1hcmtkb3duLXRhYmxlLWVkaXRvci1hY3RpdmVcIjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRWRpdG9yQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKGVkaXRvcikge1xuICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yO1xuICAgIHRoaXMuZWRpdG9ySW50ZiA9IG5ldyBUZXh0RWRpdG9ySW50ZXJmYWNlKHRoaXMuZWRpdG9yLCBhdG9tLmNvbmZpZy5nZXQoYCR7TkFNRVNQQUNFfS5zY29wZXNgKSk7XG4gICAgdGhpcy50YWJsZUVkaXRvciA9IG5ldyBUYWJsZUVkaXRvcih0aGlzLmVkaXRvckludGYpO1xuXG4gICAgdGhpcy51cGRhdGVBY3RpdmVTdGF0ZSgpO1xuXG4gICAgLy8gZXZlbnQgc3Vic2NyaXB0aW9uc1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbiAgICAvLyBlZGl0b3JcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKHRoaXMuZWRpdG9yLm9uRGlkQ2hhbmdlR3JhbW1hcigoKSA9PiB7XG4gICAgICB0aGlzLnVwZGF0ZUFjdGl2ZVN0YXRlKCk7XG4gICAgfSkpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQodGhpcy5lZGl0b3Iub25EaWRBZGRDdXJzb3IoKCkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVBY3RpdmVTdGF0ZSgpO1xuICAgIH0pKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKHRoaXMuZWRpdG9yLm9uRGlkUmVtb3ZlQ3Vyc29yKCgpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlQWN0aXZlU3RhdGUoKTtcbiAgICB9KSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZCh0aGlzLmVkaXRvci5vbkRpZENoYW5nZUN1cnNvclBvc2l0aW9uKGV2ZW50ID0+IHtcbiAgICAgIGlmICghdGhpcy5lZGl0b3JJbnRmLnRyYW5zYWN0aW9uXG4gICAgICAgICYmIGV2ZW50Lm5ld0J1ZmZlclBvc2l0aW9uLnJvdyAhPT0gZXZlbnQub2xkQnVmZmVyUG9zaXRpb24ucm93KSB7XG4gICAgICAgIHRoaXMudXBkYXRlQWN0aXZlU3RhdGUoKTtcbiAgICAgIH1cbiAgICB9KSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZCh0aGlzLmVkaXRvci5vbkRpZFN0b3BDaGFuZ2luZygoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuZWRpdG9ySW50Zi50cmFuc2FjdGlvbikge1xuICAgICAgICB0aGlzLnVwZGF0ZUFjdGl2ZVN0YXRlKCk7XG4gICAgICB9XG4gICAgfSkpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQodGhpcy5lZGl0b3JJbnRmLm9uRGlkRmluaXNoVHJhbnNhY3Rpb24oKCkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVBY3RpdmVTdGF0ZSgpO1xuICAgIH0pKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpLm9uV2lsbFNhdmUoKCkgPT4ge1xuICAgICAgaWYgKGF0b20uY29uZmlnLmdldChgJHtOQU1FU1BBQ0V9LmZvcm1hdE9uU2F2ZWApKSB7XG4gICAgICAgIHRoaXMuZm9ybWF0QWxsKCk7XG4gICAgICB9XG4gICAgfSkpO1xuXG4gICAgLy8gY29uZmlnXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKGAke05BTUVTUEFDRX0uc2NvcGVzYCwgc2NvcGVzID0+IHtcbiAgICAgIHRoaXMuZWRpdG9ySW50Zi5zY29wZXMgPSBzY29wZXM7XG4gICAgICB0aGlzLnVwZGF0ZUFjdGl2ZVN0YXRlKCk7XG4gICAgfSkpO1xuICB9XG5cbiAgdXBkYXRlQWN0aXZlU3RhdGUoKSB7XG4gICAgY29uc3QgaXNBY3RpdmUgPSAhdGhpcy5lZGl0b3IuaGFzTXVsdGlwbGVDdXJzb3JzKClcbiAgICAgICYmIHRoaXMudGFibGVFZGl0b3IuY3Vyc29ySXNJblRhYmxlKHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgICBpZiAoaXNBY3RpdmUpIHtcbiAgICAgIHRoaXMuZWRpdG9yLmVsZW1lbnQuY2xhc3NMaXN0LmFkZChBQ1RJVkVfQ0xBU1MpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRoaXMuZWRpdG9yLmVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShBQ1RJVkVfQ0xBU1MpO1xuICAgICAgdGhpcy50YWJsZUVkaXRvci5yZXNldFNtYXJ0Q3Vyc29yKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0T3B0aW9ucygpIHtcbiAgICBjb25zdCBjb25maWdPcHQgPSB7XG4gICAgICBzY29wZTogdGhpcy5lZGl0b3Iuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24odGhpcy5lZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKSlcbiAgICB9O1xuICAgIHJldHVybiBvcHRpb25zKHtcbiAgICAgIGxlZnRNYXJnaW5DaGFycyAgOiBuZXcgU2V0KGF0b20uY29uZmlnLmdldChgJHtOQU1FU1BBQ0V9LmxlZnRNYXJnaW5DaGFyc2AsIGNvbmZpZ09wdCkpLFxuICAgICAgZm9ybWF0VHlwZSAgICAgICA6IGF0b20uY29uZmlnLmdldChgJHtOQU1FU1BBQ0V9LmZvcm1hdFR5cGVgLCBjb25maWdPcHQpLFxuICAgICAgbWluRGVsaW1pdGVyV2lkdGg6IGF0b20uY29uZmlnLmdldChgJHtOQU1FU1BBQ0V9Lm1pbkRlbGltaXRlcldpZHRoYCwgY29uZmlnT3B0KSxcbiAgICAgIGRlZmF1bHRBbGlnbm1lbnQgOiBhdG9tLmNvbmZpZy5nZXQoYCR7TkFNRVNQQUNFfS5kZWZhdWx0QWxpZ25tZW50YCwgY29uZmlnT3B0KSxcbiAgICAgIGhlYWRlckFsaWdubWVudCAgOiBhdG9tLmNvbmZpZy5nZXQoYCR7TkFNRVNQQUNFfS5oZWFkZXJBbGlnbm1lbnRgLCBjb25maWdPcHQpLFxuICAgICAgc21hcnRDdXJzb3IgICAgICA6IGF0b20uY29uZmlnLmdldChgJHtOQU1FU1BBQ0V9LnNtYXJ0Q3Vyc29yYCwgY29uZmlnT3B0KSxcbiAgICAgIHRleHRXaWR0aE9wdGlvbnMgOiB7XG4gICAgICAgIG5vcm1hbGl6ZSAgICAgIDogYXRvbS5jb25maWcuZ2V0KGAke05BTUVTUEFDRX0ubm9ybWFsaXplYCwgY29uZmlnT3B0KSxcbiAgICAgICAgd2lkZUNoYXJzICAgICAgOiBuZXcgU2V0KGF0b20uY29uZmlnLmdldChgJHtOQU1FU1BBQ0V9LndpZGVDaGFyc2AsIGNvbmZpZ09wdCkpLFxuICAgICAgICBuYXJyb3dDaGFycyAgICA6IG5ldyBTZXQoYXRvbS5jb25maWcuZ2V0KGAke05BTUVTUEFDRX0ubmFycm93Q2hhcnNgLCBjb25maWdPcHQpKSxcbiAgICAgICAgYW1iaWd1b3VzQXNXaWRlOiBhdG9tLmNvbmZpZy5nZXQoYCR7TkFNRVNQQUNFfS5hbWJpZ3VvdXNBc1dpZGVgLCBjb25maWdPcHQpXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBmb3JtYXQoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5mb3JtYXQodGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgZm9ybWF0QWxsKCkge1xuICAgIHRoaXMudGFibGVFZGl0b3IuZm9ybWF0QWxsKHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIGVzY2FwZSgpIHtcbiAgICB0aGlzLnRhYmxlRWRpdG9yLmVzY2FwZSh0aGlzLmdldE9wdGlvbnMoKSk7XG4gIH1cblxuICBhbGlnbkxlZnQoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5hbGlnbkNvbHVtbihBbGlnbm1lbnQuTEVGVCwgdGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgYWxpZ25SaWdodCgpIHtcbiAgICB0aGlzLnRhYmxlRWRpdG9yLmFsaWduQ29sdW1uKEFsaWdubWVudC5SSUdIVCwgdGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgYWxpZ25DZW50ZXIoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5hbGlnbkNvbHVtbihBbGlnbm1lbnQuQ0VOVEVSLCB0aGlzLmdldE9wdGlvbnMoKSk7XG4gIH1cblxuICBhbGlnbk5vbmUoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5hbGlnbkNvbHVtbihBbGlnbm1lbnQuTk9ORSwgdGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgc2VsZWN0Q2VsbCgpIHtcbiAgICB0aGlzLnRhYmxlRWRpdG9yLnNlbGVjdENlbGwodGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgbW92ZUxlZnQoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5tb3ZlRm9jdXMoMCwgLTEsIHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIG1vdmVSaWdodCgpIHtcbiAgICB0aGlzLnRhYmxlRWRpdG9yLm1vdmVGb2N1cygwLCAxLCB0aGlzLmdldE9wdGlvbnMoKSk7XG4gIH1cblxuICBtb3ZlVXAoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5tb3ZlRm9jdXMoLTEsIDAsIHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIG1vdmVEb3duKCkge1xuICAgIHRoaXMudGFibGVFZGl0b3IubW92ZUZvY3VzKDEsIDAsIHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIG5leHRDZWxsKCkge1xuICAgIHRoaXMudGFibGVFZGl0b3IubmV4dENlbGwodGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgcHJldmlvdXNDZWxsKCkge1xuICAgIHRoaXMudGFibGVFZGl0b3IucHJldmlvdXNDZWxsKHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIG5leHRSb3coKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5uZXh0Um93KHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIGluc2VydFJvdygpIHtcbiAgICB0aGlzLnRhYmxlRWRpdG9yLmluc2VydFJvdyh0aGlzLmdldE9wdGlvbnMoKSk7XG4gIH1cblxuICBkZWxldGVSb3coKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5kZWxldGVSb3codGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgbW92ZVJvd1VwKCkge1xuICAgIHRoaXMudGFibGVFZGl0b3IubW92ZVJvdygtMSwgdGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgbW92ZVJvd0Rvd24oKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5tb3ZlUm93KDEsIHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIGluc2VydENvbHVtbigpIHtcbiAgICB0aGlzLnRhYmxlRWRpdG9yLmluc2VydENvbHVtbih0aGlzLmdldE9wdGlvbnMoKSk7XG4gIH1cblxuICBkZWxldGVDb2x1bW4oKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5kZWxldGVDb2x1bW4odGhpcy5nZXRPcHRpb25zKCkpO1xuICB9XG5cbiAgbW92ZUNvbHVtbkxlZnQoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5tb3ZlQ29sdW1uKC0xLCB0aGlzLmdldE9wdGlvbnMoKSk7XG4gIH1cblxuICBtb3ZlQ29sdW1uUmlnaHQoKSB7XG4gICAgdGhpcy50YWJsZUVkaXRvci5tb3ZlQ29sdW1uKDEsIHRoaXMuZ2V0T3B0aW9ucygpKTtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgICB0aGlzLmVkaXRvckludGYuZGVzdHJveSgpO1xuICB9XG59XG4iXX0=