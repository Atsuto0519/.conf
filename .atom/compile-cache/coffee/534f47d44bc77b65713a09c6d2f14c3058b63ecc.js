
/*
  lib/scroll.coffee
 */

(function() {
  var log,
    slice = [].slice;

  log = function() {
    var args;
    args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
    console.log.apply(console, ['markdown-scroll, scroll:'].concat(args));
    return args[0];
  };

  module.exports = {
    chkScroll: function(eventType, auto) {
      var cursorOfs, scrollFrac;
      if (this.scrollTimeout) {
        clearTimeout(this.scrollTimeout);
        this.scrollTimeout = null;
      }
      if (!this.editor.alive) {
        this.stopTracking();
        return;
      }
      if (eventType !== 'changed') {
        this.getVisTopHgtBot();
        if (this.scrnTopOfs !== this.lastScrnTopOfs || this.scrnBotOfs !== this.lastScrnBotOfs || this.previewTopOfs !== this.lastPvwTopOfs || this.previewBotOfs !== this.lastPvwBotOfs) {
          this.lastScrnTopOfs = this.scrnTopOfs;
          this.lastScrnBotOfs = this.scrnBotOfs;
          this.lastPvwTopOfs = this.previewTopOfs;
          this.lastPvwBotOfs = this.previewBotOfs;
          this.setMap(false);
        }
      }
      switch (eventType) {
        case 'init':
          cursorOfs = this.editor.getCursorScreenPosition().row * this.chrHgt;
          if ((this.scrnTopOfs <= cursorOfs && cursorOfs <= this.scrnBotOfs)) {
            return this.setScroll(cursorOfs);
          } else {
            return this.setScroll(this.scrnTopOfs);
          }
          break;
        case 'changed':
        case 'cursorMoved':
          this.setScroll(this.editor.getCursorScreenPosition().row * this.chrHgt);
          return this.ignoreScrnScrollUntil = Date.now() + 500;
        case 'newtop':
          if (this.ignoreScrnScrollUntil && Date.now() < this.ignoreScrnScrollUntil) {
            break;
          }
          this.ignoreScrnScrollUntil = null;
          scrollFrac = this.scrnTopOfs / (this.scrnScrollHgt - this.scrnHeight);
          this.setScroll(this.scrnTopOfs + (this.scrnHeight * scrollFrac));
          if (!auto) {
            return this.scrollTimeout = setTimeout(((function(_this) {
              return function() {
                return _this.chkScroll('newtop', true);
              };
            })(this)), 300);
          }
      }
    },
    setScroll: function(scrnPosPix) {
      var botPix, botRow, i, idx, lastBotPix, lastBotRow, lastMapping, len, mapping, pix1, pix2, pvwPosPix, ref, row1, row2, spanFrac, topPix, topRow, visOfs;
      scrnPosPix = Math.max(0, scrnPosPix);
      lastMapping = null;
      ref = this.map;
      for (idx = i = 0, len = ref.length; i < len; idx = ++i) {
        mapping = ref[idx];
        topPix = mapping[0], botPix = mapping[1], topRow = mapping[2], botRow = mapping[3];
        if (((topRow * this.chrHgt) <= scrnPosPix && scrnPosPix < ((botRow + 1) * this.chrHgt)) || idx === this.map.length - 1) {
          row1 = topRow;
          row2 = botRow + 1;
          pix1 = topPix;
          pix2 = botPix;
          break;
        } else {
          if (lastMapping == null) {
            lastMapping = mapping;
          }
          lastBotPix = lastMapping[1];
          lastBotRow = lastMapping[3] + 1;
          if (((lastBotRow * this.chrHgt) <= scrnPosPix && scrnPosPix < (topRow * this.chrHgt))) {
            row1 = lastBotRow;
            row2 = topRow;
            pix1 = lastBotPix;
            pix2 = topPix;
            break;
          }
        }
        lastMapping = mapping;
      }
      spanFrac = (scrnPosPix - (row1 * this.chrHgt)) / ((row2 - row1) * this.chrHgt);
      visOfs = scrnPosPix - this.scrnTopOfs;
      pvwPosPix = pix1 + ((pix2 - pix1) * spanFrac);
      return this.previewEle.scrollTop = pvwPosPix - visOfs;
    }
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL1VzZXJzL2hvdG1hbi8uYXRvbS9wYWNrYWdlcy9tYXJrZG93bi1zY3JvbGwtc3luYy9saWIvc2Nyb2xsLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7QUFBQTtBQUFBLE1BQUEsR0FBQTtJQUFBOztFQUlBLEdBQUEsR0FBTSxTQUFBO0FBQ0osUUFBQTtJQURLO0lBQ0wsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFaLENBQWtCLE9BQWxCLEVBQTJCLENBQUMsMEJBQUQsQ0FBNEIsQ0FBQyxNQUE3QixDQUFvQyxJQUFwQyxDQUEzQjtXQUNBLElBQUssQ0FBQSxDQUFBO0VBRkQ7O0VBSU4sTUFBTSxDQUFDLE9BQVAsR0FFRTtJQUFBLFNBQUEsRUFBVyxTQUFDLFNBQUQsRUFBWSxJQUFaO0FBQ1QsVUFBQTtNQUFBLElBQUcsSUFBQyxDQUFBLGFBQUo7UUFDRSxZQUFBLENBQWEsSUFBQyxDQUFBLGFBQWQ7UUFDQSxJQUFDLENBQUEsYUFBRCxHQUFpQixLQUZuQjs7TUFJQSxJQUFHLENBQUksSUFBQyxDQUFBLE1BQU0sQ0FBQyxLQUFmO1FBQTBCLElBQUMsQ0FBQSxZQUFELENBQUE7QUFBaUIsZUFBM0M7O01BRUEsSUFBRyxTQUFBLEtBQWUsU0FBbEI7UUFDRSxJQUFDLENBQUEsZUFBRCxDQUFBO1FBQ0EsSUFBRyxJQUFDLENBQUEsVUFBRCxLQUFvQixJQUFDLENBQUEsY0FBckIsSUFDQSxJQUFDLENBQUEsVUFBRCxLQUFvQixJQUFDLENBQUEsY0FEckIsSUFFQSxJQUFDLENBQUEsYUFBRCxLQUFvQixJQUFDLENBQUEsYUFGckIsSUFHQSxJQUFDLENBQUEsYUFBRCxLQUFvQixJQUFDLENBQUEsYUFIeEI7VUFJRSxJQUFDLENBQUEsY0FBRCxHQUFrQixJQUFDLENBQUE7VUFDbkIsSUFBQyxDQUFBLGNBQUQsR0FBa0IsSUFBQyxDQUFBO1VBQ25CLElBQUMsQ0FBQSxhQUFELEdBQWtCLElBQUMs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LEdBQWM7QUFuQmhCO01BcUJBLFFBQUEsR0FBWSxDQUFDLFVBQUEsR0FBYSxDQUFDLElBQUEsR0FBTyxJQUFDLENBQUEsTUFBVCxDQUFkLENBQUEsR0FBa0MsQ0FBQyxDQUFDLElBQUEsR0FBTyxJQUFSLENBQUEsR0FBZ0IsSUFBQyxDQUFBLE1BQWxCO01BQzlDLE1BQUEsR0FBYSxVQUFBLEdBQWEsSUFBQyxDQUFBO01BQzNCLFNBQUEsR0FBWSxJQUFBLEdBQU8sQ0FBQyxDQUFDLElBQUEsR0FBTyxJQUFSLENBQUEsR0FBZ0IsUUFBakI7YUFDbkIsSUFBQyxDQUFBLFVBQVUsQ0FBQyxTQUFaLEdBQXdCLFNBQUEsR0FBWTtJQTNCM0IsQ0FuRFg7O0FBVkYiLCJzb3VyY2VzQ29udGVudCI6WyIjIyNcbiAgbGliL3Njcm9sbC5jb2ZmZWVcbiMjI1xuXG5sb2cgPSAoYXJncy4uLikgLT4gXG4gIGNvbnNvbGUubG9nLmFwcGx5IGNvbnNvbGUsIFsnbWFya2Rvd24tc2Nyb2xsLCBzY3JvbGw6J10uY29uY2F0IGFyZ3NcbiAgYXJnc1swXVxuXG5tb2R1bGUuZXhwb3J0cyA9XG4gIFxuICBjaGtTY3JvbGw6IChldmVudFR5cGUsIGF1dG8pIC0+IFxuICAgIGlmIEBzY3JvbGxUaW1lb3V0XG4gICAgICBjbGVhclRpbWVvdXQgQHNjcm9sbFRpbWVvdXRcbiAgICAgIEBzY3JvbGxUaW1lb3V0ID0gbnVsbFxuICAgICAgXG4gICAgaWYgbm90IEBlZGl0b3IuYWxpdmUgdGhlbiBAc3RvcFRyYWNraW5nKCk7IHJldHVyblxuXG4gICAgaWYgZXZlbnRUeXBlIGlzbnQgJ2NoYW5nZWQnXG4gICAgICBAZ2V0VmlzVG9wSGd0Qm90KClcbiAgICAgIGlmIEBzY3JuVG9wT2ZzICAgIGlzbnQgQGxhc3RTY3JuVG9wT2ZzIG9yXG4gICAgICAgICBAc2NybkJvdE9mcyAgICBpc250IEBsYXN0U2NybkJvdE9mcyBvclxuICAgICAgICAgQHByZXZpZXdUb3BPZnMgaXNudCBAbGFzdFB2d1RvcE9mcyAgb3JcbiAgICAgICAgIEBwcmV2aWV3Qm90T2ZzIGlzbnQgQGxhc3RQdndCb3RPZnNcbiAgICAgICAgQGxhc3RTY3JuVG9wT2ZzID0gQHNjcm5Ub3BPZnNcbiAgICAgICAgQGxhc3RTY3JuQm90T2ZzID0gQHNjcm5Cb3RPZnNcbiAgICAgICAgQGxhc3RQdndUb3BPZnMgID0gQHByZXZpZXdUb3BPZnNcbiAgICAgICAgQGxhc3RQdndCb3RPZnMgID0gQHByZXZpZXdCb3RPZnNcbiAgICBcbiAgICAgICMge3dpZHRoOnNjcm5XLCBoZWlnaHQ6c2Nybkh9ID0gQGVkaXRvclZpZXcuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgICMge3dpZHRoOnB2d1csIGhlaWdodDpwdndIfSAgID0gQHByZXZpZXdFbGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgICMgaWYgc2NyblcgaXNudCBAbGFzdFNjcm5XIG9yXG4gICAgICAjICAgIHNjcm5IIGlzbnQgQGxhc3RTY3JuSCBvclxuICAgICAgIyAgICBwdndXICBpc250IEBsYXN0UHZ3VyAgb3JcbiAgICAgICMgICAgcHZ3SCAgaXNudCBAbGFzdFB2d0hcbiAgICAgICMgICBAbGFzdFNjcm5XID0gc2NyblcgICAgXG4gICAgICAjICAgQGxhc3RTY3JuSCA9IHNjcm5IXG4gICAgICAjICAgQGxhc3RQdndXICA9IHB2d1cgXG4gICAgICAjICAgQGxhc3RQdndIICA9IHB2d0ggXG4gICAgICBcbiAgICAgICAgQHNldE1hcCBub1xuICAgIFxuICAgIHN3aXRjaCBldmVudFR5cGVcbiAgICAgIHdoZW4gJ2luaXQnXG4gICAgICAgIGN1cnNvck9mcyAgPSBAZWRpdG9yLmdldEN1cnNvclNjcmVlblBvc2l0aW9uKCkucm93ICogQGNockhndFxuICAgICAgICBpZiBAc2NyblRvcE9mcyA8PSBjdXJzb3JPZnMgPD0gQHNjcm5Cb3RPZnMgXG4gICAgICAgICAgICAgQHNldFNjcm9sbCBjdXJzb3JPZnNcbiAgICAgICAgZWxzZSBAc2V0U2Nyb2xsIEBzY3JuVG9wT2ZzXG4gICAgICAgICAgXG4gICAgICB3aGVuICdjaGFuZ2VkJywgJ2N1cnNvck1vdmVkJyBcbiAgICAgICAgQHNldFNjcm9sbCBAZWRpdG9yLmdldEN1cnNvclNjcmVlblBvc2l0aW9uKCkucm93ICogQGNockhndFxuICAgICAgICBAaWdub3JlU2NyblNjcm9sbFVudGlsID0gRGF0ZS5ub3coKSArIDUwMFxuICAgICAgXG4gICAgICB3aGVuICduZXd0b3AnXG4gICAgICAgIGlmIEBpZ25vcmVTY3JuU2Nyb2xsVW50aWwgYW5kXG4gICAgICAgICAgIERhdGUubm93KCkgPCBAaWdub3JlU2NyblNjcm9sbFVudGlsIHRoZW4gYnJlYWtcbiAgICAgICAgQGlnbm9yZVNjcm5TY3JvbGxVbnRpbCA9IG51bGxcbiAgICAgICAgc2Nyb2xsRnJhYyA9IEBzY3JuVG9wT2ZzIC8gKEBzY3JuU2Nyb2xsSGd0IC0gQHNjcm5IZWlnaHQpXG4gICAgICAgIEBzZXRTY3JvbGwgICBAc2NyblRvcE9mcyArIChAc2NybkhlaWdodCAqIHNjcm9sbEZyYWMpXG4gICAgICAgIGlmIG5vdCBhdXRvXG4gICAgICAgICAgQHNjcm9sbFRpbWVvdXQgPSBzZXRUaW1lb3V0ICg9PiBAY2hrU2Nyb2xsICduZXd0b3AnLCB5ZXMpLCAzMDBcbiAgXG4gIHNldFNjcm9sbDogKHNjcm5Qb3NQaXgpIC0+XG4gICAgc2NyblBvc1BpeCA9IE1hdGgubWF4IDAsIHNjcm5Qb3NQaXhcbiAgICBsYXN0TWFwcGluZyA9IG51bGxcbiAgICBmb3IgbWFwcGluZywgaWR4IGluIEBtYXBcbiAgICAgIFt0b3BQaXgsIGJvdFBpeCwgdG9wUm93LCBib3RSb3ddID0gbWFwcGluZ1xuICAgICAgaWYgKHRvcFJvdyAqIEBjaHJIZ3QpIDw9IHNjcm5Qb3NQaXggPCAoKGJvdFJvdysxKSAqIEBjaHJIZ3QpIG9yIFxuICAgICAgICAgIGlkeCBpcyBAbWFwLmxlbmd0aCAtIDFcbiAgICAgICAgcm93MSA9IHRvcFJvd1xuICAgICAgICByb3cyID0gYm90Um93ICsgMVxuICAgICAgICBwaXgxID0gdG9wUGl4XG4gICAgICAgIHBpeDIgPSBib3RQaXhcbiAgICAgICAgYnJlYWsgICAgICBcbiAgICAgIGVsc2VcbiAgICAgICAgbGFzdE1hcHBpbmcgPz0gbWFwcGluZ1xuICAgICAgICBsYXN0Qm90UGl4ID0gbGFzdE1hcHBpbmdbMV1cbiAgICAgICAgbGFzdEJvdFJvdyA9IGxhc3RNYXBwaW5nWzNdICsgMVxuICAgICAgICBpZiAobGFzdEJvdFJvdyAqIEBjaHJIZ3QpIDw9IHNjcm5Qb3NQaXggPCAodG9wUm93ICogQGNockhndClcbiAgICAgICAgICByb3cxID0gbGFzdEJvdFJvd1xuICAgICAgICAgIHJvdzIgPSB0b3BSb3dcbiAgICAgICAgICBwaXgxID0gbGFzdEJvdFBpeFxuICAgICAgICAgIHBpeDIgPSB0b3BQaXhcbiAgICAgICAgICBicmVha1xuICAgICAgbGFzdE1hcHBpbmcgPSBtYXBwaW5nXG4gICAgICBcbiAgICBzcGFuRnJhYyAgPSAoc2NyblBvc1BpeCAtIChyb3cxICogQGNockhndCkpIC8gKChyb3cyIC0gcm93MSkgKiBAY2hySGd0KVxuICAgIHZpc09mcyAgICA9ICBzY3JuUG9zUGl4IC0gQHNjcm5Ub3BPZnNcbiAgICBwdndQb3NQaXggPSBwaXgxICsgKChwaXgyIC0gcGl4MSkgKiBzcGFuRnJhYylcbiAgICBAcHJldmlld0VsZS5zY3JvbGxUb3AgPSBwdndQb3NQaXggLSB2aXNPZnNcbiAgICBcbiJdfQ==
